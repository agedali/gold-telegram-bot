import os
import requests
from bs4 import BeautifulSoup
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CallbackQueryHandler, ContextTypes
)
from datetime import datetime, time
import asyncio
import nest_asyncio

nest_asyncio.apply()

# --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© ---
TOKEN = os.getenv("TELEGRAM_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
GOLDAPI_KEY = os.getenv("GOLDAPI_KEY")

# --- Ø¯Ø§Ù„Ø© Ø³Ø­Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ ---
def get_gold_prices():
    url = "https://www.goldapi.io/api/XAU/USD"
    headers = {"x-access-token": GOLDAPI_KEY, "Content-Type": "application/json"}
    try:
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        data = response.json()

        # Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† GOLDAPI
        gram24 = data.get("price_gram_24k") or data.get("price")  # ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­
        if not gram24:
            print("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨")
            return None

        return {
            "gram_24": gram24,
            "gram_22": gram24 * 22 / 24,
            "gram_21": gram24 * 21 / 24,
            "ounce": data.get("price_ounce") or 0
        }
    except Exception as e:
        print("âŒ Error fetching gold prices:", e)
        return None

# --- Ø¯Ø§Ù„Ø© Ø³Ø­Ø¨ Ø³Ø¹Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ÙˆØ§Ù„ÙŠÙˆØ±Ùˆ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ ---
def get_fx_rates():
    try:
        url = "https://qamaralfajr.com/production/exchange_rates.php"
        headers = {"User-Agent": "Mozilla/5.0"}
        response = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(response.text, "html.parser")
        rates = {}
        table = soup.find("table")
        if not table:
            print("âŒ Ù„Ù… Ø£Ø¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙÙŠ Ø§Ù„ØµÙØ­Ø©")
            return {}

        for row in table.find_all("tr"):
            cols = row.find_all("td")
            if len(cols) >= 3:
                currency = cols[0].text.strip()
                buy = cols[1].text.strip().replace(",", "")
                sell = cols[2].text.strip().replace(",", "")
                if currency in ["USD", "EUR"]:
                    rates[currency] = {"buy": buy, "sell": sell}
        if not rates:
            print("âŒ Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ÙˆØ§Ù„ÙŠÙˆØ±Ùˆ")
        return rates
    except Exception as e:
        print("âŒ Error fetching FX rates:", e)
        return {}

# --- ØµÙŠØ§ØºØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ---
def format_message():
    gold = get_gold_prices()
    fx = get_fx_rates()
    msg = f"ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"

    if gold:
        msg += "ğŸ’° Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ:\n"
        msg += f"â€¢ Ø¹ÙŠØ§Ø± 24: {gold['gram_24']:.2f} $\n"
        msg += f"â€¢ Ø¹ÙŠØ§Ø± 22: {gold['gram_22']:.2f} $\n"
        msg += f"â€¢ Ø¹ÙŠØ§Ø± 21: {gold['gram_21']:.2f} $\n"
        msg += f"â€¢ Ø§Ù„Ø£ÙˆÙ†ØµØ©: {gold['ounce']:.2f} $\n\n"
    else:
        msg += "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨.\n\n"

    if fx:
        msg += "ğŸ’± Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ:\n"
        for curr in fx:
            msg += f"â€¢ {curr} Ø´Ø±Ø§Ø¡: {fx[curr]['buy']} | Ø¨ÙŠØ¹: {fx[curr]['sell']}\n"
    else:
        msg += "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ØµØ±Ù.\n"

    return msg

# --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹ Ø²Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ---
async def send_prices(context: ContextTypes.DEFAULT_TYPE):
    msg = format_message()
    keyboard = [
        [InlineKeyboardButton("Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­", callback_data="calculate_profit")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await context.bot.send_message(chat_id=CHAT_ID, text=msg, reply_markup=reply_markup)

# --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ---
async def button_handler(update: "telegram.Update", context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await query.edit_message_text(text="ğŸ’° Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ø§Ù…Ø§Øª ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙˆØª Ù„Ø§Ø­Ù‚Ù‹Ø§")

# --- Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙƒÙ„ Ø³Ø§Ø¹Ø© Ù…Ù† 10 ØµØ¨Ø§Ø­Ù‹Ø§ Ø­ØªÙ‰ 6 Ù…Ø³Ø§Ø¡Ù‹ ---
async def schedule_prices(app):
    for hour in range(10, 19):
        app.job_queue.run_daily(send_prices, time=time(hour, 0, 0))

# --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ---
async def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CallbackQueryHandler(button_handler, pattern="calculate_profit"))

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
    await send_prices(app)

    # Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    await schedule_prices(app)

    print("âœ… Bot is running...")
    await app.run_polling()

if __name__ == "__main__":
    asyncio.run(main())
